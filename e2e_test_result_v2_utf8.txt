============================= test session starts =============================
platform win32 -- Python 3.14.0, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\Nyx\AppData\Local\Programs\Python\Python314\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\Nyx\Desktop\MANGACOLOR
configfile: pytest.ini
plugins: anyio-4.12.0
collecting ... 
----------------------------- live log collection -----------------------------
2026-02-14 22:37:03 [    INFO] Loading faiss with AVX2 support.
2026-02-14 22:37:03 [    INFO] Successfully loaded faiss with AVX2 support.
collected 8 items

tests/e2e/test_char_id_flow.py::TestCharIdFlowE2E::test_detections_have_char_id_after_pipeline_processing 
-------------------------------- live log call --------------------------------
2026-02-14 22:37:11 [    INFO] Inicializado: C:\Users\Nyx\AppData\Local\Temp\pytest-of-Nyx\pytest-66\test_detections_have_char_id_a0\chapter_cache\ch_test_e2e
PASSED                                                                   [ 12%]
tests/e2e/test_char_id_flow.py::TestCharIdFlowE2E::test_tile_job_receives_char_ids 
-------------------------------- live log call --------------------------------
2026-02-14 22:37:11 [    INFO] Inicializado: C:\Users\Nyx\AppData\Local\Temp\pytest-of-Nyx\pytest-66\test_tile_job_receives_char_id0\chapter_cache\ch_test_e2e
PASSED                                                                   [ 25%]
tests/e2e/test_char_id_flow.py::TestCharIdFlowE2E::test_embedding_loaded_for_char_id 
-------------------------------- live log call --------------------------------
2026-02-14 22:37:11 [    INFO] Inicializado: C:\Users\Nyx\AppData\Local\Temp\pytest-of-Nyx\pytest-66\test_embedding_loaded_for_char0\chapter_cache\ch_test_e2e
PASSED                                                                   [ 37%]
tests/e2e/test_char_id_flow.py::TestCharIdContractAssertions::test_detection_has_required_keys_after_linking PASSED [ 50%]
tests/e2e/test_char_id_flow.py::TestCharIdContractAssertions::test_tile_job_active_char_ids_not_empty_when_chars_present PASSED [ 62%]
tests/e2e/test_pipeline.py::test_full_pipeline_simulation ERROR          [ 75%]
tests/e2e/test_pipeline.py::test_pipeline_analysis_phase 
-------------------------------- live log call --------------------------------
2026-02-14 22:37:17 [    INFO] Inicializado em cpu com torch.float16
2026-02-14 22:37:17 [    INFO] Iniciando Passo 1: Anßlise de 1 pßginas
2026-02-14 22:37:17 [    INFO] Chapter ID: 1c90ca46d553
2026-02-14 22:37:17 [    INFO] Pass1Analyzer inicializado (device=cpu, sam2=True, zbuffer=True)
2026-02-14 22:37:17 [    INFO] Inicializado: chapter_cache\1c90ca46d553
2026-02-14 22:37:17 [    INFO] Analisando pßgina 1/1
2026-02-14 22:37:17 [    INFO] Analisando pßgina 0: C:\Users\Nyx\AppData\Local\Temp\pytest-of-Nyx\pytest-66\test_pipeline_analysis_phase0\test_chapter\page_001.png
2026-02-14 22:37:17 [    INFO] 0 personagens detectados (body+face)
2026-02-14 22:37:19 [    INFO] 1 personagens salvos
2026-02-14 22:37:19 [    INFO] 1 tiles salvos
2026-02-14 22:37:19 [    INFO] 1 pßginas salvas
2026-02-14 22:37:19 [    INFO] Cache persistido em: chapter_cache\1c90ca46d553
2026-02-14 22:37:19 [    INFO] 1 personagens salvos
2026-02-14 22:37:19 [    INFO] 1 tiles salvos
2026-02-14 22:37:19 [    INFO] 1 pßginas salvas
2026-02-14 22:37:19 [    INFO] Cache persistido em: chapter_cache\1c90ca46d553
2026-02-14 22:37:19 [    INFO] Passo 1 completo: 0 personagens detectados
PASSED                                                                   [ 87%]
tests/e2e/test_pipeline.py::test_pipeline_components_wired 
-------------------------------- live log call --------------------------------
2026-02-14 22:37:19 [    INFO] Inicializado em cpu com torch.float16
PASSED                                                                   [100%]

=================================== ERRORS ====================================
_______________ ERROR at setup of test_full_pipeline_simulation _______________

    @pytest.fixture
    def mock_dependencies():
        """Mocks heavy dependencies (YOLO, SDXL, etc.)"""
        with patch('core.detection.yolo_detector.YOLODetector') as MockDetector, \
             patch('core.pipeline.HybridIdentityEncoder') as MockIdentity, \
             patch('core.generation.pipeline.SD15LineartEngine') as MockEngine, \
>            patch('core.generation.pipeline.MangaPromptBuilder') as MockPromptBuilder, \
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
             patch('core.generation.pipeline.TilingManager') as MockTilingManager, \
             patch('core.database.chapter_db.VectorIndex') as MockVectorIndex:

tests\e2e\test_pipeline.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
..\..\AppData\Local\Programs\Python\Python314\Lib\unittest\mock.py:1503: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x0000021B415A5810>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'core.generation.pipeline' from 'C:\\Users\\Nyx\\Desktop\\MANGACOLOR\\core\\generation\\pipeline.py'> does not have the attribute 'MangaPromptBuilder'

..\..\AppData\Local\Programs\Python\Python314\Lib\unittest\mock.py:1473: AttributeError
============================== warnings summary ===============================
<frozen importlib._bootstrap>:491
  <frozen importlib._bootstrap>:491: DeprecationWarning: builtin type SwigPyPacked has no __module__ attribute

<frozen importlib._bootstrap>:491
  <frozen importlib._bootstrap>:491: DeprecationWarning: builtin type SwigPyObject has no __module__ attribute

<frozen importlib._bootstrap>:491
  <frozen importlib._bootstrap>:491: DeprecationWarning: builtin type swigvarlink has no __module__ attribute

tests/e2e/test_pipeline.py::test_pipeline_analysis_phase
tests/e2e/test_pipeline.py::test_pipeline_analysis_phase
  C:\Users\Nyx\AppData\Local\Programs\Python\Python314\Lib\site-packages\sklearn\base.py:1336: ConvergenceWarning: Number of distinct clusters (1) found smaller than n_clusters (5). Possibly due to duplicate points in X.
    return fit_method(estimator, *args, **kwargs)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
ERROR tests/e2e/test_pipeline.py::test_full_pipeline_simulation - AttributeEr...
=================== 7 passed, 5 warnings, 1 error in 15.86s ===================
